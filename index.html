<!doctype html>
<html lang="en">
<head>
<title>Objective-C Implementation and Performance Details for C and C++ Programmers</title>
<!-- 2017-08-06 Sun 19:20 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Scott Wolchok">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style type="text/css">
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<style>body { margin-bottom: 0px; }</style><style type="text/css">.src { background-color: #000; color: #fff; }</style>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-9"><h1 class="title">Objective-C Implementation and Performance Details for C and C++ Programmers</h1>
<div class="byline">
  <p class="author">Scott Wolchok</p>
  <p class="pub-date">August 6, 2017</>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
It is easy for C and C++ programmers to learn the "Objective" parts of
Objective-C by treating them as new syntax for the same things they
are used to doing in C or C++. While this is a great way to learn
quickly, it can be misleading. The Objective-C runtime's features (and
consequent performance characteristics) are arguably closer to
scripting languages like Python than to C++. This article explains
enough details of Objective-C implementation to give you a more
correct mental model of how common constructs will perform.
</p>

<p>
In this text, I assume that you already know Objective-C reasonably
well and that you are an efficiency-minded C++ or C programmer. You
will need to be able to read assembly language to fully understand the
examples. Sections are organized around Objective-C features. Each
section will introduce its feature briefly, explain how it works on
64-bit iOS devices as of Xcode 8.3.3, and walk through an example.
</p>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1"><span class="section-number-3">1.1</span> Resources</h3>
<div class="outline-text-3" id="text-1-1">
<p>
This text will occasionally make reference to <a href="http://opensource.apple.com/source/objc4/">Apple's Objective-C
runtime open source release</a>. While I have included links inline to the
most recent version at publication time, you may also find it useful to check out <a href="https://github.com/opensource-apple/objc4">the
unofficial GitHub mirror</a>.
</p>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2"><span class="section-number-3">1.2</span> About the examples</h3>
<div class="outline-text-3" id="text-1-2">
<p>
All examples in this text are compiled with the following script (C++
examples substitute clang++):
</p>

<div class="org-src-container">

<pre class="src src-sh"><span style="color: #ff7f24;">#</span><span style="color: #ff7f24;">!/usr/bin/</span><span style="color: #00ffff;">env</span><span style="color: #ff7f24;"> bash</span>

xcrun --sdk iphoneos clang -arch arm64 -S -Os $<span style="color: #eedd82;">@</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-1-3" class="outline-3">
<h3 id="sec-1-3"><span class="section-number-3">1.3</span> Disclaimer</h3>
<div class="outline-text-3" id="text-1-3">
<p>
I am publishing this article in my own personal capacity. The views
expressed herein are my own and do not necessarily reflect those of my
employer.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Class Metadata</h2>
<div class="outline-text-2" id="text-2">
<p>
Objective-C classes are defined in two major pieces:
<code>@interface</code> and <code>@implementation</code>.
</p>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> @interface vs. @implementation</h3>
<div class="outline-text-3" id="text-2-1">
<p>
<code>@interface</code> by itself produces no artifacts in the compiled
program; it is for static checking only. For example, here is a
file containing an unimplemented <code>@interface</code> that uses lots of
features:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">Noop</span>
{
<span style="color: #00ffff;">@private</span>
  <span style="color: #98fb98;">NSString</span> *<span style="color: #eedd82;">privateIvar</span>;
<span style="color: #00ffff;">@protected</span>
  <span style="color: #98fb98;">NSString</span> *<span style="color: #eedd82;">protectedIvar</span>;
<span style="color: #00ffff;">@public</span>
  <span style="color: #98fb98;">NSString</span> *<span style="color: #eedd82;">publicIvar</span>;
}
- (<span style="color: #98fb98;">int</span>)<span style="color: #87cefa;">anInstanceMethod</span>;
+ (<span style="color: #98fb98;">float</span>)<span style="color: #87cefa;">aClassMethod</span>;

@property (<span style="color: #98fb98;">atomic</span>, <span style="color: #98fb98;">readwrite</span>, <span style="color: #98fb98;">copy</span>) <span style="color: #98fb98;">NSString</span> *<span style="color: #eedd82;">aProperty</span>;

<span style="color: #00ffff;">@end</span>
</pre>
</div>

<p>
When we compile it, we can see that it generates no actual code:
</p>

<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.section</span>        __TEXT,__text,regular,pure_instructions
        <span style="color: #00ffff;">.ios_version_min</span> 10, 3
        <span style="color: #00ffff;">.section</span>        __DATA,__objc_imageinfo,regular,no_dead_strip
<span style="color: #87cefa;">L_OBJC_IMAGE_INFO</span>:
        <span style="color: #00ffff;">.long</span>   0
        <span style="color: #00ffff;">.long</span>   64


<span style="color: #00ffff;">.subsections_via_symbols</span>
</pre>
</div>

<p>
(Similar content appears in the assembly for the rest
of the examples, but I've omitted it for brevity.)
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Class artifacts</h3>
<div class="outline-text-3" id="text-2-2">
<p>
<code>@implementation</code>, then, is what really triggers class artifacts to
start showing up. How is each thing we can add to a class
represented?
</p>
</div>

<div id="outline-container-sec-2-2-1" class="outline-4">
<h4 id="sec-2-2-1"><span class="section-number-4">2.2.1</span> Empty class</h4>
<div class="outline-text-4" id="text-2-2-1">
<p>
Let's first consider a simple empty class:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">SomeClass</span> : <span style="color: #98fb98;">NSObject</span>
<span style="color: #00ffff;">@end</span>

<span style="color: #00ffff;">@implementation</span> <span style="color: #98fb98;">SomeClass</span>
<span style="color: #00ffff;">@end</span>
</pre>
</div>

<p>
Here is what the compiler produces given this definition:
</p>

<ul class="org-ul">
<li>C-string name of the class (<code>L_OBJC_CLASS_NAME_</code>)
</li>
<li>5-word <code>struct objc_class</code> (see <a href="http://opensource.apple.com/source/objc4/objc4-709/runtime/objc-runtime-new.h">objc-runtime-new.h</a>) describing the
class and another one for its metaclass
(<code>_OBJC_CLASS_$_SomeClass</code> and <code>_OBJC_METACLASS_$_SomeClass</code>)
</li>
<li>9-word <code>struct class_ro_t</code> (see <a href="http://www.opensource.apple.com/source/objc4/objc4-680/runtime/objc-runtime-new.h">objc-runtime-new.h</a>) for the class &amp;
another one for its metaclass (<code>l_OBJC_CLASS_RO_$_SomeClass</code> and
<code>l_OBJC_METACLASS_RO_$_SomeClass</code>)
</li>
<li>Pointer to the class in the <code>__DATA.__objc_classlist</code> section
</li>
</ul>

<p>
In short, on a 64-bit machine, each class <code>@implementation</code> will
cause the compiler to emit the class name, at least 224 bytes of metadata
structures, and a pointer to one of the metadata structures being
emitted.
</p>

<p>
Here is the full assembly:
</p>

<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_classname,cstring_literals
<span style="color: #87cefa;">L_OBJC_CLASS_NAME</span>_:                     <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_CLASS_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"SomeClass"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_METACLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_METACLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_METACLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_METACLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_METACLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_METACLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_CLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_CLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   0                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x0</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_CLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_CLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_CLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_SomeClass
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_CLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_classlist,regular,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_LABEL_CLASS_$"</span>
<span style="color: #87cefa;">L_OBJC_LABEL_CLASS_$</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_SomeClass
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-2-2-2" class="outline-4">
<h4 id="sec-2-2-2"><span class="section-number-4">2.2.2</span> Ivars</h4>
<div class="outline-text-4" id="text-2-2-2">
<p>
What if we add an ivar?
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">SomeClass</span> : <span style="color: #98fb98;">NSObject</span>
{
  <span style="color: #98fb98;">NSString</span> *<span style="color: #eedd82;">anIvar</span>;
}
<span style="color: #00ffff;">@end</span>

<span style="color: #00ffff;">@implementation</span> <span style="color: #98fb98;">SomeClass</span>
<span style="color: #00ffff;">@end</span>
</pre>
</div>

<p>
   The name and type of the ivar will be emitted as C strings, and
   referenced in the new <code>struct ivar_t</code> (see <a href="http://www.opensource.apple.com/source/objc4/objc4-680/runtime/objc-runtime-new.h">objc-runtime-new.h</a>) ivar
   list for the class. We also get a new <code>struct ivar_list_t</code> (<code>l_OBJC_$_INSTANCE_VARIABLES_SomeClass</code>)
), which contains our new <code>struct ivar_t</code> plus 8 bytes of overhead,
   and our <code>struct objc_class</code> now points to <code>l_OBJC_$_INSTANCE_VARIABLES_SomeClass</code>:
</p>

<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_classname,cstring_literals
<span style="color: #87cefa;">L_OBJC_CLASS_NAME</span>_:                     <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_CLASS_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"SomeClass"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_METACLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_METACLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_METACLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_METACLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_METACLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_METACLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_ivar
        <span style="color: #00ffff;">.globl</span>  _OBJC_IVAR_$_SomeClass.anIvar <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_IVAR_$_SomeClass.anIvar"</span>
        <span style="color: #00ffff;">.p2align</span>        2
<span style="color: #87cefa;">_OBJC_IVAR_$_SomeClass</span>.anIvar:
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methname,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_NAME</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"anIvar"</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methtype,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_TYPE</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_TYPE_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"@\"NSString\""</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_$_INSTANCE_VARIABLES_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_$_INSTANCE_VARIABLES_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   32                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x20</span>
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.quad</span>   _OBJC_IVAR_$_SomeClass.anIvar
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_NAME_
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_TYPE_
        <span style="color: #00ffff;">.long</span>   3                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x3</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>

        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_CLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_CLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   0                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x0</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>
        <span style="color: #00ffff;">.long</span>   16                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x10</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_$_INSTANCE_VARIABLES_SomeClass
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_CLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_CLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_CLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_SomeClass
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_CLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_classlist,regular,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_LABEL_CLASS_$"</span>
<span style="color: #87cefa;">L_OBJC_LABEL_CLASS_$</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_SomeClass
</pre>
</div>

<p>
Note that when Objective-C++ is in use, the full "compiler error
message" version of the name of any class types used in ivars will
be emitted. This can be quite large if we use a C++ template class
like <code>std::unordered_map</code>:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;string&gt;</span>
<span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;unordered_map&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">SomeClass</span> : <span style="color: #98fb98;">NSObject</span>
{
  std::unordered_map&lt;std::string, std::string&gt; aHugeIvar;
}
<span style="color: #00ffff;">@end</span>

<span style="color: #00ffff;">@implementation</span> <span style="color: #98fb98;">SomeClass</span>
<span style="color: #00ffff;">@end</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"{unordered_map&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt;, std::__1::hash&lt;std::__1::basic_string&lt;char&gt; &gt;, std::__1::equal_to&lt;std::__1::basic_string&lt;char&gt; &gt;, std::__1::allocator&lt;std::__1::pair&lt;const std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt; &gt; &gt;=\"__table_\"{__hash_table&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, std::__1::__unordered_map_hasher&lt;std::__1::basic_string&lt;char&gt;, std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, std::__1::hash&lt;std::__1::basic_string&lt;char&gt; &gt;, true&gt;, std::__1::__unordered_map_equal&lt;std::__1::basic_string&lt;char&gt;, std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, std::__1::equal_to&lt;std::__1::basic_string&lt;char&gt; &gt;, true&gt;, std::__1::allocator&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt; &gt; &gt;=\"__bucket_list_\"{unique_ptr&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt; *[], std::__1::__bucket_list_deallocator&lt;std::__1::allocator&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt; *&gt; &gt; &gt;=\"__ptr_\"{__compressed_pair&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt; **, std::__1::__bucket_list_deallocator&lt;std::__1::allocator&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt; *&gt; &gt; &gt;=\"__first_\"^^{__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt;}\"__second_\"{__bucket_list_deallocator&lt;std::__1::allocator&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt; *&gt; &gt;=\"__data_\"{__compressed_pair&lt;unsigned long, std::__1::allocator&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt; *&gt; &gt;=\"__first_\"Q}}}}\"__p1_\"{__compressed_pair&lt;std::__1::__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt;, std::__1::allocator&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; &gt; &gt;=\"__first_\"{__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt;=\"__next_\"^{__hash_node_base&lt;std::__1::__hash_node&lt;std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, void *&gt; *&gt;}}}\"__p2_\"{__compressed_pair&lt;unsigned long, std::__1::__unordered_map_hasher&lt;std::__1::basic_string&lt;char&gt;, std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, std::__1::hash&lt;std::__1::basic_string&lt;char&gt; &gt;, true&gt; &gt;=\"__first_\"Q}\"__p3_\"{__compressed_pair&lt;float, std::__1::__unordered_map_equal&lt;std::__1::basic_string&lt;char&gt;, std::__1::__hash_value_type&lt;std::__1::basic_string&lt;char&gt;, std::__1::basic_string&lt;char&gt; &gt;, std::__1::equal_to&lt;std::__1::basic_string&lt;char&gt; &gt;, true&gt; &gt;=\"__first_\"f}}}"</span>
</pre>
</div>

<p>
(It is not clear to me what purpose this is intended to serve.)
</p>
</div>
</div>

<div id="outline-container-sec-2-2-3" class="outline-4">
<h4 id="sec-2-2-3"><span class="section-number-4">2.2.3</span> Methods</h4>
<div class="outline-text-4" id="text-2-2-3">
<p>
Let's add a method:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">SomeClass</span> : <span style="color: #98fb98;">NSObject</span>
- (<span style="color: #98fb98;">void</span>)<span style="color: #87cefa;">doSomething</span>;
<span style="color: #00ffff;">@end</span>

<span style="color: #00ffff;">@implementation</span> <span style="color: #98fb98;">SomeClass</span>
- (<span style="color: #98fb98;">void</span>)<span style="color: #87cefa;">doSomething</span> {}
<span style="color: #00ffff;">@end</span>
</pre>
</div>

<p>
The code generation is extremely similar to what we would get if
we added a new ivar, except we also have code emitted for the
new method. The name and signature of the method will be emitted
as C strings, referenced in the new <code>struct method_t</code> for the
method. We also get a new <code>struct method_list_t</code>
(<code>l_OBJC_$_INSTANCE_METHODS_SomeClass:</code>) with 8 bytes of overhead
that is referenced by our <code>struct objc_class</code>.
</p>

<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.p2align</span>        2
<span style="color: #ffa07a;">"-[SomeClass doSomething]"</span>:             <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01-[SomeClass doSomething]"</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
        <span style="color: #00ffff;">ret</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_classname,cstring_literals
<span style="color: #87cefa;">L_OBJC_CLASS_NAME</span>_:                     <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_CLASS_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"SomeClass"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_METACLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_METACLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_METACLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_METACLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_METACLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_METACLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methname,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_NAME</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"doSomething"</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methtype,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_TYPE</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_TYPE_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"v16@0:8"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_$_INSTANCE_METHODS_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_$_INSTANCE_METHODS_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   24                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x18</span>
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_NAME_
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_TYPE_
        <span style="color: #00ffff;">.quad</span>   <span style="color: #ffa07a;">"-[SomeClass doSomething]"</span>

        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_CLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_CLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   0                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x0</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   l_OBJC_$_INSTANCE_METHODS_SomeClass
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_CLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_CLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_CLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_SomeClass
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_CLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_classlist,regular,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_LABEL_CLASS_$"</span>
<span style="color: #87cefa;">L_OBJC_LABEL_CLASS_$</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_SomeClass
</pre>
</div>

<p>
The same caveats about Objective-C++ that apply to ivars apply to
methods too.
</p>
</div>
</div>

<div id="outline-container-sec-2-2-4" class="outline-4">
<h4 id="sec-2-2-4"><span class="section-number-4">2.2.4</span> Properties</h4>
<div class="outline-text-4" id="text-2-2-4">
<p>
Finally, how about a property?
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">SomeClass</span> : <span style="color: #98fb98;">NSObject</span>
@property (<span style="color: #98fb98;">readonly</span>, <span style="color: #98fb98;">nonatomic</span>, <span style="color: #98fb98;">retain</span>) <span style="color: #98fb98;">NSString</span> *<span style="color: #eedd82;">aString</span>;
<span style="color: #00ffff;">@end</span>

<span style="color: #00ffff;">@implementation</span> <span style="color: #98fb98;">SomeClass</span>
<span style="color: #00ffff;">@end</span>
</pre>
</div>

<p>
We get code emitted for the backing ivar (<code>_aString</code>) and backing getter (<code>-[SomeClass aString]</code>) for
our property, as covered in the previous sections.  We also get an
extra C string describing our property's attributes, which is
referenced in the new <code>struct property_t</code>, and we also
have a new <code>struct property_list_t</code> because we just added the
first property. Again, see <a href="http://opensource.apple.com//source/objc4/objc4-709%20/runtime/objc-runtime-new.h">objc-runtime-new.h</a> for structure
definitions.
</p>

<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.p2align</span>        2
<span style="color: #ffa07a;">"-[SomeClass aString]"</span>:                 <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01-[SomeClass aString]"</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
<span style="color: #87cefa;">Lloh0</span>:
        <span style="color: #00ffff;">adrp</span>    x8, _OBJC_IVAR_$_SomeClass._aString@PAGE
<span style="color: #87cefa;">Lloh1</span>:
        <span style="color: #00ffff;">ldrsw</span>   x8, [x8, _OBJC_IVAR_$_SomeClass._aString@PAGEOFF]
        <span style="color: #00ffff;">ldr</span>             x0, [x0, x8]
        <span style="color: #00ffff;">ret</span>
        <span style="color: #00ffff;">.loh</span> AdrpLdr    Lloh0, Lloh1

        <span style="color: #00ffff;">.private_extern</span> _OBJC_IVAR_$_SomeClass._aString <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_IVAR_$_SomeClass._aString"</span>
        <span style="color: #00ffff;">.section</span>        __DATA,__objc_ivar
        <span style="color: #00ffff;">.globl</span>  _OBJC_IVAR_$_SomeClass._aString
        <span style="color: #00ffff;">.p2align</span>        2
<span style="color: #87cefa;">_OBJC_IVAR_$_SomeClass</span>._aString:
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_classname,cstring_literals
<span style="color: #87cefa;">L_OBJC_CLASS_NAME</span>_:                     <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_CLASS_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"SomeClass"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_METACLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_METACLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.long</span>   40                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x28</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   0

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_METACLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_METACLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_METACLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_METACLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methname,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_NAME</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"aString"</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methtype,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_TYPE</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_TYPE_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"@16@0:8"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_$_INSTANCE_METHODS_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_$_INSTANCE_METHODS_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   24                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x18</span>
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_NAME_
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_TYPE_
        <span style="color: #00ffff;">.quad</span>   <span style="color: #ffa07a;">"-[SomeClass aString]"</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methname,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_NAME</span>_.1:                <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_NAME_.1</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"_aString"</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methtype,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_TYPE</span>_.2:                <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_TYPE_.2</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"@\"NSString\""</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_$_INSTANCE_VARIABLES_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_$_INSTANCE_VARIABLES_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   32                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x20</span>
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.quad</span>   _OBJC_IVAR_$_SomeClass._aString
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_NAME_.1
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_TYPE_.2
        <span style="color: #00ffff;">.long</span>   3                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x3</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__cstring,cstring_literals
<span style="color: #87cefa;">L_OBJC_PROP_NAME_ATTR</span>_:                 <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_PROP_NAME_ATTR_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"aString"</span>

<span style="color: #87cefa;">L_OBJC_PROP_NAME_ATTR</span>_.3:               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_PROP_NAME_ATTR_.3</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"T@\"NSString\",R,&amp;,N,V_aString"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_const
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_$_PROP_LIST_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_$_PROP_LIST_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   16                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x10</span>
        <span style="color: #00ffff;">.long</span>   1                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x1</span>
        <span style="color: #00ffff;">.quad</span>   L_OBJC_PROP_NAME_ATTR_
        <span style="color: #00ffff;">.quad</span>   L_OBJC_PROP_NAME_ATTR_.3

        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01l_OBJC_CLASS_RO_$_SomeClass"</span>
<span style="color: #87cefa;">l_OBJC_CLASS_RO_$_SomeClass</span>:
        <span style="color: #00ffff;">.long</span>   0                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x0</span>
        <span style="color: #00ffff;">.long</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>
        <span style="color: #00ffff;">.long</span>   16                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x10</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   L_OBJC_CLASS_NAME_
        <span style="color: #00ffff;">.quad</span>   l_OBJC_$_INSTANCE_METHODS_SomeClass
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_$_INSTANCE_VARIABLES_SomeClass
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_$_PROP_LIST_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_data
        <span style="color: #00ffff;">.globl</span>  _OBJC_CLASS_$_SomeClass <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_CLASS_$_SomeClass"</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_OBJC_CLASS_$_SomeClass</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_METACLASS_$_SomeClass
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_NSObject
        <span style="color: #00ffff;">.quad</span>   __objc_empty_cache
        <span style="color: #00ffff;">.quad</span>   0
        <span style="color: #00ffff;">.quad</span>   l_OBJC_CLASS_RO_$_SomeClass

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_classlist,regular,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_LABEL_CLASS_$"</span>
<span style="color: #87cefa;">L_OBJC_LABEL_CLASS_$</span>:
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_SomeClass
</pre>
</div>

<p>
The extra property metadata is accessible with <a href="https://developer.apple.com/documentation/objectivec/objective_c_runtime?language=objc">the Objective-C
runtime</a>.  For example, we could get the property by name with
<code>class_getProperty</code> and we could get the attribute string with
<code>property_getAttributes</code>. If we knew we would never want to do
this, it would be better for code size to manually write an ivar
and getter rather than using <code>@property</code>.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Ivar Access</h2>
<div class="outline-text-2" id="text-3">
<p>
Ivars are not quite as efficient to access as C or C++ struct
members. Recall that struct member access is as simple as loading
from an offset into the struct:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">SomeStruct</span> {
  <span style="color: #98fb98;">double</span> <span style="color: #eedd82;">dbl</span>; <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">Added to make it more clear how offsets are handled by</span>
              <span style="color: #ff7f24;">// </span><span style="color: #ff7f24;">giving x a nonzero offset.</span>
  <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">x</span>;
  <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">y</span>;
};

<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">accessMember</span>(<span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">SomeStruct</span> *<span style="color: #eedd82;">o</span>)
{
  <span style="color: #00ffff;">return</span> o-&gt;x + o-&gt;y;
}

<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">accessArray</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">o</span>[4]) {
  <span style="color: #00ffff;">return</span> o[2] + o[3];
}
</pre>
</div>
<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.globl</span>  _accessMember
        <span style="color: #00ffff;">.p2align</span>        2
<span style="color: #87cefa;">_accessMember</span>:                          <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@accessMember</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
        <span style="color: #00ffff;">ldp</span>     w8, w9, [x0, #8]
        <span style="color: #00ffff;">add</span>             w0, w9, w8
        <span style="color: #00ffff;">ret</span>

        <span style="color: #00ffff;">.globl</span>  _accessArray
        <span style="color: #00ffff;">.p2align</span>        2
<span style="color: #87cefa;">_accessArray</span>:                           <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@accessArray</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
        <span style="color: #00ffff;">ldp</span>     w8, w9, [x0, #8]
        <span style="color: #00ffff;">add</span>             w0, w9, w8
        <span style="color: #00ffff;">ret</span>
</pre>
</div>

<p>
To read <code>x</code> and <code>y</code>, <code>accessStruct</code> just loads from offsets 8 and 12
at the location pointed to by <code>o</code>. (As it happens, the <code>ldp</code>
("Load Pair") instruction lets us load two ints at once in this case.) This case
is exactly the same as if we were to pass an array of ints, as
in <code>accessArray</code>.
</p>

<p>
Compare this to ivar access:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #00ffff;">@interface</span> <span style="color: #98fb98;">SomeClass</span> : <span style="color: #98fb98;">NSObject</span>
{
  <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">x</span>;
  <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">y</span>;
}
<span style="color: #00ffff;">@end</span>

<span style="color: #00ffff;">@implementation</span> <span style="color: #98fb98;">SomeClass</span>
- (<span style="color: #98fb98;">int</span>)<span style="color: #87cefa;">accessIvar</span>
{
  <span style="color: #00ffff;">return</span> x + y;
}
<span style="color: #00ffff;">@end</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #ffa07a;">"-[SomeClass accessIvar]"</span>:              <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"\01-[SomeClass accessIvar]"</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
<span style="color: #87cefa;">Lloh0</span>:
        <span style="color: #00ffff;">adrp</span>    x8, _OBJC_IVAR_$_SomeClass.x@PAGE
<span style="color: #87cefa;">Lloh1</span>:
        <span style="color: #00ffff;">ldrsw</span>   x8, [x8, _OBJC_IVAR_$_SomeClass.x@PAGEOFF]
        <span style="color: #00ffff;">ldr</span>             w8, [x0, x8]
<span style="color: #87cefa;">Lloh2</span>:
        <span style="color: #00ffff;">adrp</span>    x9, _OBJC_IVAR_$_SomeClass.y@PAGE
<span style="color: #87cefa;">Lloh3</span>:
        <span style="color: #00ffff;">ldrsw</span>   x9, [x9, _OBJC_IVAR_$_SomeClass.y@PAGEOFF]
        <span style="color: #00ffff;">ldr</span>             w9, [x0, x9]
        <span style="color: #00ffff;">add</span>             w0, w9, w8
        <span style="color: #00ffff;">ret</span>
</pre>
</div>

<p>
Instead of one load per struct member access (previously combined
into <code>ldp</code>), we are now looking at a load of a PC-relative pointer
offset (<code>adrp</code> (PC-relative address of 4KB page) and <code>ldrsw</code> (load
register signed word)), and a second load (<code>ldr</code>) using that offset into
<code>self</code> (which is in <code>x0</code>).
</p>

<p>
In pseudo-C, this is something like
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #98fb98;">ptrdiff_t</span> <span style="color: #eedd82;">xOffset</span> = SomeClass_x_ivar-&gt;offset;
<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">x</span> = *(<span style="color: #98fb98;">int</span> *)((<span style="color: #98fb98;">char</span> *)self + xOffset);
<span style="color: #98fb98;">ptrdiff_t</span> <span style="color: #eedd82;">yOffset</span> = SomeClass_y_ivar-&gt;offset
<span style="color: #98fb98;">int</span> y = *(<span style="color: #98fb98;">int</span> *)((<span style="color: #98fb98;">char</span> *)self + yOffset);
<span style="color: #00ffff;">return</span> x + y;
</pre>
</div>

<p>
For C++ experts, the code generated for ivar access is virtually
identical to the code generated for the following contrived example
of access via pointer-to-member:
</p>

<div class="org-src-container">

<pre class="src src-c++"><span style="color: #00ffff;">struct</span> <span style="color: #98fb98;">SomeStruct</span> {
  <span style="color: #98fb98;">double</span> <span style="color: #eedd82;">dbl</span>;
  <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">x</span>;
  <span style="color: #98fb98;">int</span> <span style="color: #eedd82;">y</span>;
};

<span style="color: #98fb98;">int</span> <span style="color: #7fffd4;">SomeStruct</span>::*<span style="color: #eedd82;">xPtr</span> = &amp;<span style="color: #7fffd4;">SomeStruct</span>::x;
<span style="color: #98fb98;">int</span> <span style="color: #7fffd4;">SomeStruct</span>::*<span style="color: #eedd82;">yPtr</span> = &amp;<span style="color: #7fffd4;">SomeStruct</span>::y;

<span style="color: #98fb98;">int</span> <span style="color: #87cefa;">accessViaMemPtr</span>(<span style="color: #98fb98;">SomeStruct</span> *<span style="color: #eedd82;">o</span>) {
  <span style="color: #00ffff;">return</span> o-&gt;*xPtr + o-&gt;*yPtr;
}
</pre>
</div>

<p>
Assembly:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">__Z15accessViaMemPtrP10SomeStruct</span>:      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@_Z15accessViaMemPtrP10SomeStruct</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
<span style="color: #87cefa;">Lloh0</span>:
        <span style="color: #00ffff;">adrp</span>    x8, _xPtr@PAGE
<span style="color: #87cefa;">Lloh1</span>:
        <span style="color: #00ffff;">ldr</span>     x8, [x8, _xPtr@PAGEOFF]
        <span style="color: #00ffff;">ldr</span>             w8, [x0, x8]
<span style="color: #87cefa;">Lloh2</span>:
        <span style="color: #00ffff;">adrp</span>    x9, _yPtr@PAGE
<span style="color: #87cefa;">Lloh3</span>:
        <span style="color: #00ffff;">ldr</span>     x9, [x9, _yPtr@PAGEOFF]
        <span style="color: #00ffff;">ldr</span>             w9, [x0, x9]
        <span style="color: #00ffff;">add</span>             w0, w9, w8
        <span style="color: #00ffff;">ret</span>
        <span style="color: #00ffff;">.loh</span> AdrpLdr    Lloh0, Lloh1
        <span style="color: #00ffff;">.loh</span> AdrpLdr    Lloh2, Lloh3

        <span style="color: #00ffff;">.section</span>        __DATA,__data
        <span style="color: #00ffff;">.globl</span>  _xPtr                   <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@xPtr</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_xPtr</span>:
        <span style="color: #00ffff;">.quad</span>   8                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x8</span>

        <span style="color: #00ffff;">.globl</span>  _yPtr                   <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@yPtr</span>
        <span style="color: #00ffff;">.p2align</span>        3
<span style="color: #87cefa;">_yPtr</span>:
        <span style="color: #00ffff;">.quad</span>   12                      <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0xc</span>
</pre>
</div>

<p>
<a href="http://www.sealiesoftware.com/blog/archive/2009/01/27/objc_explain_Non-fragile_ivars.html">This article</a> explains that the reason for the extra indirection in
ivar access is to solve the fragile base class problem: unlike in
C++, if a superclass has more ivars added, subclasses don't have to
be recompiled to adjust their ivar offsets. Instead, the Objective-C
runtime can just make this adjustment at load time.
</p>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Functions and Methods</h2>
<div class="outline-text-2" id="text-4">
<p>
If you're coming from C++, you may have assumed that Objective-C method
calls are implemented similarly to virtual method calls. However,
this assumption is misleading. The differences in behavior
all stem from the <i>call-by-name</i> semantics of Objective-C calls,
together with the dynamic nature of the language.
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1"><span class="section-number-3">4.1</span> Instance method invocation</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Let's start by comparing the code the compiler generates for a
simple method call in Objective-C to the code we'd get in C or
C++. To avoid dealing with assembly, let's treat a C function call
as our baseline and describe C++ and Objective-C calls in terms of
C.
</p>

<p>
When we call a virtual function on an object like <code>o-&gt;doStuff()</code>,
clang uses the classic vtable approach. (If you're unfamiliar with
it, <code>o-&gt;doStuff()</code> compiles to roughly
<code>o-&gt;vtbl-&gt;doStuffFunctionPointer()</code>, where <code>o-&gt;vtbl</code> is a pointer
to a structure containing one function pointer for each virtual
function.) At the assembly level, this is roughly a load and an
indirect jump.
</p>

<p>
Compare that to an example Objective-C call:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #98fb98;">void</span> <span style="color: #87cefa;">callIndirect</span>(<span style="color: #98fb98;">id</span> <span style="color: #eedd82;">o</span>) {
  [o doStuff];
}
</pre>
</div>

<p>
Assembly:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">_callIndirect</span>:                          <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@callIndirect</span>
        <span style="color: #00ffff;">.cfi_startproc</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
<span style="color: #87cefa;">Lloh0</span>:
        <span style="color: #00ffff;">adrp</span>    x8, L_OBJC_SELECTOR_REFERENCES_@PAGE
<span style="color: #87cefa;">Lloh1</span>:
        <span style="color: #00ffff;">ldr</span>     x1, [x8, L_OBJC_SELECTOR_REFERENCES_@PAGEOFF]
        <span style="color: #00ffff;">b</span>       _objc_msgSend
        <span style="color: #00ffff;">.loh</span> AdrpLdr    Lloh0, Lloh1
        <span style="color: #00ffff;">.cfi_endproc</span>

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methname,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_NAME</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"doStuff"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_selrefs,literal_pointers,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_SELECTOR_REFERENCES_</span>
<span style="color: #87cefa;">L_OBJC_SELECTOR_REFERENCES</span>_:
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_NAME_
</pre>
</div>

<p>
So, <code>[o doStuff]</code> is roughly equivalent to 
<code>objc_msgSend(o, OBJC_SELECTOR_REFERENCES[DO_STUFF_OFFSET])</code>, where
<code>OBJC_SELECTOR_REFERENCES</code> is a large array of pointers to selectors and
<code>DO_STUFF_OFFSET</code> is an integer constant. At the assembly level,
this is also roughly a load and an indirect (because of dynamic
linking) jump. However, we have additional overhead in
<code>objc_msgSend</code> at runtime!
</p>

<p>
There are <a href="https://www.mikeash.com/pyblog/friday-qa-2012-11-16-lets-build-objc_msgsend.html">entire</a> <a href="http://www.friday.com/bbum/2009/12/18/objc_msgsend-part-1-the-road-map/">articles</a> on <code>objc_msgSend</code> that cover the topic
much better than I could. In brief, <code>objc_msgSend</code> has two phases:
</p>
<ol class="org-ol">
<li>Look up the selector in the cache of the object's class's
recently used methods. (The cache is an open-addressing hash
table with a really simple hash function: `hash(x) = x`. It
will grow to accommodate all called methods.) If found, we're
done.
</li>
<li>Binary search the object's class's method list. If found, we're
done. If not found, try the superclass and repeat this step.
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="section-number-3">4.2</span> Class method invocation</h3>
<div class="outline-text-3" id="text-4-2">
<p>
If you write a lot of Objective-C code, eventually you may find
that you habitually use class methods. In C++, static methods are
efficient: they are called just like C functions. In Objective-C, class
methods are a relative disaster: they are called just like
Objective-C instance methods!
</p>

<p>
Here's our example:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #98fb98;">void</span> <span style="color: #87cefa;">callClassMethod</span>() {
  [<span style="color: #98fb98;">NSString</span> alloc];
}
</pre>
</div>
<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">_callClassMethod</span>:                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@callClassMethod</span>
        <span style="color: #00ffff;">.cfi_startproc</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
<span style="color: #87cefa;">Lloh0</span>:
        <span style="color: #00ffff;">adrp</span>    x8, L_OBJC_CLASSLIST_REFERENCES_$_@PAGE
<span style="color: #87cefa;">Lloh1</span>:
        <span style="color: #00ffff;">ldr</span>     x0, [x8, L_OBJC_CLASSLIST_REFERENCES_$_@PAGEOFF]
<span style="color: #87cefa;">Lloh2</span>:
        <span style="color: #00ffff;">adrp</span>    x8, L_OBJC_SELECTOR_REFERENCES_@PAGE
<span style="color: #87cefa;">Lloh3</span>:
        <span style="color: #00ffff;">ldr</span>     x1, [x8, L_OBJC_SELECTOR_REFERENCES_@PAGEOFF]
        <span style="color: #00ffff;">b</span>       _objc_msgSend
        <span style="color: #00ffff;">.loh</span> AdrpAdrp   Lloh0, Lloh2
        <span style="color: #00ffff;">.loh</span> AdrpLdr    Lloh0, Lloh1
        <span style="color: #00ffff;">.loh</span> AdrpLdr    Lloh2, Lloh3
        <span style="color: #00ffff;">.cfi_endproc</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_classrefs,regular,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@"OBJC_CLASSLIST_REFERENCES_$_"</span>
<span style="color: #87cefa;">L_OBJC_CLASSLIST_REFERENCES_$</span>_:
        <span style="color: #00ffff;">.quad</span>   _OBJC_CLASS_$_NSString

        <span style="color: #00ffff;">.section</span>        __TEXT,__objc_methname,cstring_literals
<span style="color: #87cefa;">L_OBJC_METH_VAR_NAME</span>_:                  <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_METH_VAR_NAME_</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"alloc"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__objc_selrefs,literal_pointers,no_dead_strip
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@OBJC_SELECTOR_REFERENCES_</span>
<span style="color: #87cefa;">L_OBJC_SELECTOR_REFERENCES</span>_:
        <span style="color: #00ffff;">.quad</span>   L_OBJC_METH_VAR_NAME_
</pre>
</div>


<p>
As we can see, the overhead is even higher than for instance
methods: <code>[MyClass doStuff]</code> compiles to
<code>objc_msgSend(OBJC_CLASSLIST_REFERENCES[MYCLASS_OFFSET],
   OBJC_SELECTOR_REFERENCESS[DO_STUFF_OFFSET])</code>; we have the same old
load for the selector as well as a second load to fetch the global
class pointer, and then we have <code>objc_msgSend</code> on top of that.
</p>
</div>
</div>

<div id="outline-container-sec-4-3" class="outline-3">
<h3 id="sec-4-3"><span class="section-number-3">4.3</span> Dynamicity and optimization</h3>
<div class="outline-text-3" id="text-4-3">
<p>
Because the Objective-C runtime allows classes' method
implementations to be changed at any time (see e.g.,
<a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/index.html#//apple_ref/c/func/class_addMethod">class_addMethod</a>, <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/index.html#//apple_ref/c/func/method_setImplementation">method_setImplementation</a>, <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtDynamicResolution.html">dynamic method
resolution</a>, <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtForwarding.html#//apple_ref/doc/uid/TP40008048-CH105-SW1">message forwarding</a>, etc.), the compiler cannot possibly
prove what code will actually be executed by any particular method
call. This disables several common optimizations:
</p>

<dl class="org-dl">
<dt> Common subexpression elimination </dt><dd>If you repeat a call to an
inline getter method in C++, you can reasonably expect that that
method will still be called only once. This is not the case in
Objective-C, not even for properties. In other words, if you
write <code>if ([o foo]) { [o2 setBar:[o foo]]; }</code>, <code>-foo</code> will get
called twice. It does not matter if you spell it <code>if (o.foo) {
     o2.bar = o.foo; }</code>; the two are identical.
</dd>
<dt> Inlining and devirtualization </dt><dd>Since the compiler cannot
determine what method implementation will be executed, it
certainly cannot inline that implementation or insert a direct call to it.
</dd>
</dl>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Blocks</h2>
<div class="outline-text-2" id="text-5">
<p>
<a href="http://clang.llvm.org/docs/Block-ABI-Apple.html">Apple's documentation on the block ABI</a> is quite thorough. Salient points:
</p>

<ul class="org-ul">
<li>Each instance of a particular block takes up at least 4 words on a
64-bit machine
</li>
<li>Each block kind takes up another 2-5 words
</li>
<li>Calling a block is implemented by calling a C function through a
function pointer and passing it a pointer to the block instance
</li>
</ul>

<p>
Let's just quickly verify it:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #b0c4de;">#include</span> <span style="color: #ffa07a;">&lt;stdio.h&gt;</span>
<span style="color: #98fb98;">void</span> <span style="color: #87cefa;">callBlock</span>(<span style="color: #98fb98;">void</span> (^block)(<span style="color: #98fb98;">void</span>)) {
  block();
}
</pre>
</div>
<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">_callBlock</span>:                             <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@callBlock</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
        <span style="color: #00ffff;">ldr</span>     x1, [x0, #16]
        <span style="color: #00ffff;">br</span>      x1
</pre>
</div>

<p>
Sure looks like our block call is loading the <code>invoke</code> function
pointer and calling it, just like we'd expect from Apple's documentation.
</p>

<p>
Access to captured variables is like struct access:
</p>

<div class="org-src-container">

<pre class="src src-c"><span style="color: #b0c4de;">#include</span> <span style="color: #ffa07a;">&lt;Block.h&gt;</span>

<span style="color: #00ffff;">typedef</span> <span style="color: #98fb98;">int</span> (^intBlock)(<span style="color: #98fb98;">int</span>);

<span style="color: #98fb98;">intBlock</span> <span style="color: #87cefa;">makeAdder</span>(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">x</span>) {
  <span style="color: #00ffff;">return</span> Block_copy(^(<span style="color: #98fb98;">int</span> <span style="color: #eedd82;">y</span>) {
    <span style="color: #00ffff;">return</span> x + y;
  });
}
</pre>
</div>

<p>
The assembly for the inner block is:
</p>

<div class="org-src-container">

<pre class="src src-asm"><span style="color: #87cefa;">___makeAdder_block_invoke</span>:              <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@__makeAdder_block_invoke</span>
<span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">BB#0:</span>
        <span style="color: #00ffff;">ldr</span>     w8, [x0, #32]
        <span style="color: #00ffff;">add</span>             w0, w8, w1
        <span style="color: #00ffff;">ret</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Literals</h2>
<div class="outline-text-2" id="text-6">
<p>
Objective-C has convenient literal syntax for creating instances of
<code>NSString</code>, <code>NSNumber</code>, <code>NSArray</code>, and <code>NSDictionary</code>. As explained
in <a href="https://clang.llvm.org/docs/ObjectiveCLiterals.html">Clang's documentation</a>, nearly all the literal syntax is just
sugar for the appropriate constructor. The one exception is
NSString:
</p>

<div class="org-src-container">

<pre class="src src-objc"><span style="color: #b0c4de;">#import</span> <span style="color: #ffa07a;">&lt;Foundation/Foundation.h&gt;</span>

<span style="color: #98fb98;">NSString</span> *<span style="color: #87cefa;">getLiteral</span>()
{
  <span style="color: #00ffff;">return</span> @<span style="color: #ffa07a;">"Hello"</span>;
}
</pre>
</div>
<div class="org-src-container">

<pre class="src src-asm">        <span style="color: #00ffff;">.section</span>        __TEXT,__cstring,cstring_literals
<span style="color: #87cefa;">L</span>_.str:                                 <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@.str</span>
        <span style="color: #00ffff;">.asciz</span>  <span style="color: #ffa07a;">"Hello"</span>

        <span style="color: #00ffff;">.section</span>        __DATA,__cfstring
        <span style="color: #00ffff;">.p2align</span>        3               <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">@_unnamed_cfstring_</span>
<span style="color: #87cefa;">L__unnamed_cfstring</span>_:
        <span style="color: #00ffff;">.quad</span>   ___CFConstantStringClassReference
        <span style="color: #00ffff;">.long</span>   1992                    <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x7c8</span>
        <span style="color: #00ffff;">.space</span>  4
        <span style="color: #00ffff;">.quad</span>   L_.str
        <span style="color: #00ffff;">.quad</span>   5                       <span style="color: #ff7f24;">; </span><span style="color: #ff7f24;">0x5</span>
</pre>
</div>

<p>
Our literal is stored as a structure with 4 elements:
<code>___CFConstantStringClassReference</code> (presumably the <code>isa</code> pointer),
a constant that is probably used by the implementation, a pointer
to the C-string version of the string, and its length. In other
words, @"Hello"
is <b>not</b> a shortcut for <code>+[NSString stringWithUTF8String:"Hello"]</code>; it's more efficient!
</p>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Conclusion</h2>
<div class="outline-text-2" id="text-7">
<p>
Because of the dynamic nature of Objective-C, using Objective-C
features is often less efficient than C or C++ equivalents. On the
other hand, Objective-C is easier to use than C or C++. Now that you
know more about Objective-C performance, you can make better decisions
about when to choose Objective-C.
</p>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51201348-3', 'auto');
  ga('send', 'pageview');

</script>
</div>
</div>
</div><div class="col-md-3"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Introduction</a>
<ul class="nav">
<li><a href="#sec-1-1">1.1. Resources</a></li>
<li><a href="#sec-1-2">1.2. About the examples</a></li>
<li><a href="#sec-1-3">1.3. Disclaimer</a></li>
</ul>
</li>
<li><a href="#sec-2">2. Class Metadata</a>
<ul class="nav">
<li><a href="#sec-2-1">2.1. @interface vs. @implementation</a></li>
<li><a href="#sec-2-2">2.2. Class artifacts</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Ivar Access</a></li>
<li><a href="#sec-4">4. Functions and Methods</a>
<ul class="nav">
<li><a href="#sec-4-1">4.1. Instance method invocation</a></li>
<li><a href="#sec-4-2">4.2. Class method invocation</a></li>
<li><a href="#sec-4-3">4.3. Dynamicity and optimization</a></li>
</ul>
</li>
<li><a href="#sec-5">5. Blocks</a></li>
<li><a href="#sec-6">6. Literals</a></li>
<li><a href="#sec-7">7. Conclusion</a></li>
</ul>
</div>
</nav>
</div></div></div>
</body>
</html>
